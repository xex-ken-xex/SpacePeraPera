# ゲーム仕様書 (v2.0)

## 概要
銀河英雄伝説IIIスタイルの艦隊戦シミュレーター。Three.jsを用いた3D空間でのリアルタイム艦隊戦闘を実現。プレイヤーはユニットに移動や攻撃目標を指示し、各ユニットは自律的に戦闘を行います。

## 技術スタック
- **レンダリング**: Three.js (WebGL)
- **UI**: HTML/CSS (グラスモーフィズムデザイン)
- **空間UI**: CSS2DRenderer (ユニット名、HPバー、ダメージ表示)
- **カメラ**: OrbitControls (回転・ズーム・パン対応)

## コード設計
### ユニット管理
- **データ駆動設計**: ユニットの性能（HP、攻撃力など）は、`js/unitBlueprints.js` ファイルに「設計図」として一元管理されています。
- **拡張性**: 新ユニットの追加や既存ユニットのバランス調整は、この設計図ファイルを修正するだけで完了するため、ゲームロジックに影響を与えません。
- **初期配置**: `game.js` は、起動時に設計図を読み込み、定義されたデータに基づいて戦場にユニットを動的に生成します。

## 座標系と移動
- **座標**: 3D空間座標系。X-Z平面が戦場、Y軸が高さ方向。
- **移動**: ユニットは目標地点が指定されると、自身の移動速度に基づいてリアルタイムに移動します。
- **回頭**: ユニットは目標地点に向かう際、即座に方向転換するのではなく、設定された回頭速度に基づいて滑らかに旋回します。90度の回頭には約3秒かかります。
- **カメラ操作**:
  - **WASD**: カメラの平行移動
  - **マウスドラッグ**: カメラの回転
  - **マウスホイール**: ズーム（調整により、より迅速な操作が可能になりました）

## 視覚表現
### ユニット表現
- 各ユニットは**100隻**の艦艇メッシュで構成される艦隊として表現されます。
- 艦艇数はユニットの現在HPに応じてリアルタイムに減少し、視覚的に損害状況を示します。

### 空間UI
- **ユニット名とHPバー**: 各ユニットの上空に3D空間内で表示されます。
- **ダメージポップアップ**: ダメージ数値が3D空間で浮遊し、フェードアウトします。

### デバッグ表示
- **カーソルガイド**: マウスが指す地面の位置を示す円形ガイド。
- **ヒットエリアリング**: 各ユニットのクリック可能範囲を示す白いリング。

### 範囲表示
- **攻撃範囲**: 選択中のユニットの攻撃可能範囲を赤い円で表示します。選択されたユニットの範囲円は、ユニットの移動に合わせてリアルタイムで追従します。

## 戦闘ルール (リアルタイム制)
1.  **選択 (左クリック)**:
    -   自軍ユニットを左クリックすると、そのユニットが選択されます。
2.  **命令 (右クリック)**:
    -   ユニットを選択した状態で、地面を右クリックすると、その地点への**移動命令**となります。
    -   敵ユニットを右クリックすると、その敵への**集中攻撃命令**となります。ユニットはその敵を優先的に追跡・攻撃します。
3.  **自動攻撃 (セミオート)**:
    -   ユニットは、特定の命令がない場合（`IDLE`状態）、自身の攻撃範囲内に入ってきた敵を自動的に索敵し、最も近い敵を攻撃します。
    -   集中攻撃命令を受けている最中でも、目標が射程内にいれば自動で攻撃を繰り返します。ただし、目標に照準が合っている（一定の角度内にいる）必要があります。

## 陣形 (Formation)
ユニットは複数の陣形を組むことができ、戦況に応じて切り替えることが可能です。
- **デフォルト陣形**: **ライン**
- **陣形変更**: 陣形の切り替えは瞬時に行われず、**約4秒**かけて艦艇が新しい配置に滑らかに移動します。

### 陣形一覧
| 陣形名 | 攻撃補正 | 防御補正 | 移動補正 | 説明 |
| :--- | :---: | :---: | :---: | :--- |
| **ライン (Line)** | x1.2 | x0.9 | x0.9 | 進行方向に対して横一列に展開する戦闘隊形。広範囲への攻撃に優れる。 |
| **スピンドル (Spindle)** | x1.1 | x1.0 | x1.0 | 進行方向に長い紡錘形の陣形。突破力と標準的な攻防バランスを持つ。 |
| **リング (Ring)** | x0.95 | x1.2 | x0.85 | 全方位に対応可能な円形陣形。防御力に優れるが機動性は低い。 |

## 戦闘エフェクト
### ビーム攻撃アニメーション
- 各艦艇から個別にビームが発射されます。
- **発射タイミング**: 各艦艇が0〜300msのランダムな遅延で発射（スケール感の演出）。
- **マズルフラッシュ**: 発射時に砲口に青白い光球が出現します。
- **着弾エフェクト**: 着弾点にオレンジ色の爆発エフェクトが表示されます。
- **ビーム表現**: 青白い光線が徐々にフェードアウトします。
- **着弾分散**: 各ビームの着弾点に微小なランダムオフセットを付与します。

### ダメージ表示
- ダメージ数値が3D空間で上昇しながらフェードアウトします。
- 赤色の数値で視認性を確保します。

## AIロジック
- **基本動作**: AIユニットは、プレイヤーユニットと同様に半自動で行動します。つまり、攻撃範囲内に敵が入れば自動で攻撃します。
- **目標選定**: AIユニットに特定の命令がなく、周囲に敵もいない場合、`_updateAI`関数が定期的に戦況を評価し、マップ上で最も近いプレイヤーユニットを新たな目標として設定します。これにより、AI艦隊は自動的に戦闘地域へ移動します。

## UI構成
### HUDオーバーレイ
- **コマンドデッキ**: ゲームリセットボタン、フォーメーション選択ボタン。
- **メッセージログ**: ゲーム進行状況のメッセージ表示。
- **選択ユニット情報パネル**: 選択中のユニットの詳細（名前、HP、攻撃力、防御力、移動力、射程など）。

### スタイル
- グラスモーフィズムデザイン（半透明背景、ぼかし効果）。
- 暗色系の配色で3D戦場を引き立てます。
- ホバー時のアニメーション効果。

## アニメーションシステム
ゲームループ内でアニメーションオブジェクトを管理し、デルタタイムベースで更新します。
- **BeamAnimation**: 艦隊一斉射撃アニメーション（遅延発射、マズルフラッシュ、着弾エフェクト）。
- **ExplosionAnimation**: 爆発エフェクト。
- **DamagePopupAnimation**: ダメージ数値の浮遊表示。

## 今後の拡張予定
- 陣形機能の更なる高度化（陣形ごとの特殊能力など）。
- ユニットの向き（heading）によるダメージ計算の高度化。
- より高度なAI思考ルーチン（集団での行動、退却判断など）。
- 追加の視覚エフェクト（トレイル、パーティクル等）。
- キーボードによるショートカットキーの実装。
- 新しいユニット種別の追加（設計図システムにより容易化済み）。
